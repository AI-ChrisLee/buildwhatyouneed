# Version 1.1 Implementation Plan - Free Tier User Flow

## Overview
This document outlines the implementation plan for adding a free tier with limited access to encourage conversions to paid memberships.

## New User Flow
1. **Home Page (/)** → User clicks "Free Access" CTA
2. **Registration** → User creates free account (no payment required)
3. **Limited Access** → User can access ONE free course only
4. **Conversion Prompt** → When trying to access premium content, show payment modal
5. **Upgrade** → User converts to paid member for full access

## Technical Implementation

### Phase 1: Database Schema Updates (Using Supabase MCP)

```sql
-- 1. Update user profiles for membership tiers
ALTER TABLE profiles ADD COLUMN IF NOT EXISTS membership_tier TEXT DEFAULT 'free';
ALTER TABLE profiles ADD COLUMN IF NOT EXISTS tier_created_at TIMESTAMP DEFAULT NOW();

-- 2. Create courses table with free/paid distinction
CREATE TABLE IF NOT EXISTS courses (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    title TEXT NOT NULL,
    description TEXT,
    is_free BOOLEAN DEFAULT FALSE,
    thumbnail_url TEXT,
    content JSONB,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- 3. Create user course access tracking
CREATE TABLE IF NOT EXISTS user_course_access (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
    course_id UUID REFERENCES courses(id) ON DELETE CASCADE,
    accessed_at TIMESTAMP DEFAULT NOW(),
    completed BOOLEAN DEFAULT FALSE,
    UNIQUE(user_id, course_id)
);

-- 4. Mock data for courses
INSERT INTO courses (title, description, is_free, content) VALUES
('Introduction to Our Community', 'Get started with our platform - FREE course', TRUE, '{"modules": ["Welcome", "Basic Features", "Community Guidelines"]}'),
('Advanced Marketing Strategies', 'Premium course for serious entrepreneurs', FALSE, '{"modules": ["Market Research", "Digital Marketing", "Growth Hacking"]}'),
('Financial Freedom Blueprint', 'Master your finances and build wealth', FALSE, '{"modules": ["Budgeting", "Investing", "Passive Income"]}'),
('Leadership Mastery', 'Become an effective leader in your business', FALSE, '{"modules": ["Team Building", "Communication", "Decision Making"]}');
```

### Phase 2: Authentication Flow Updates

1. **Update Registration Flow** (`/src/app/api/auth/signup/route.ts`)
   ```typescript
   // Key changes:
   - Remove Stripe customer creation for free tier
   - Set membership_tier = 'free' in users table
   - Auto-grant access to free course:
     INSERT INTO user_course_access (user_id, course_id)
     SELECT $userId, id FROM courses WHERE is_free = true LIMIT 1
   - Send different welcome email for free vs paid users
   ```

2. **Create Free Access Form** (`/src/components/forms/FreeAccessForm.tsx`)
   ```typescript
   interface FreeAccessFormData {
     email: string;
     password: string;
     fullName: string;
   }
   
   // Features:
   - Simple form with basic fields only
   - No payment step
   - Clear value prop: "Get instant access to our free course"
   - After signup: redirect to /dashboard/courses/free
   ```

3. **Update Home Page CTA** (`/src/app/page.tsx`)
   - Change primary CTA from "Join Now" to "Get Free Access"
   - Add secondary CTA: "See Pricing" for immediate upgrades
   - Update hero copy to emphasize free trial value

### Phase 3: Access Control Implementation

1. **Create Access Control Hook** (`/src/hooks/useAccessControl.ts`)
   ```typescript
   interface AccessControl {
     canAccessCourse: (courseId: string) => Promise<boolean>;
     canAccessThreads: boolean;
     canAccessCalendar: boolean;
     membershipTier: 'free' | 'paid';
     hasAccessToFreeCourse: boolean;
   }
   
   export function useAccessControl(): AccessControl {
     // Query user's membership_tier from users table
     // For free users:
     //   - canAccessThreads = false
     //   - canAccessCalendar = false
     //   - canAccessCourse = true only for free courses
     // For paid users: full access to everything
   }
   ```

2. **Create Course Access Service** (`/src/lib/course-access.ts`)
   ```typescript
   // Server-side validation functions:
   export async function checkCourseAccess(userId: string, courseId: string) {
     // 1. Check if course is free (anyone can access)
     // 2. Check user's membership tier
     // 3. Check user_course_access table
     // Return: { hasAccess: boolean, reason?: string }
   }
   
   export async function grantFreeCourseAccess(userId: string) {
     // Called after signup to grant access to free course
     // Insert record into user_course_access
   }
   ```

3. **Update Course Components**
   ```typescript
   // CourseCard.tsx
   interface CourseCardProps {
     course: Course;
     userTier: 'free' | 'paid';
     onUpgradeClick: () => void;
   }
   
   // Features:
   - Show lock icon overlay for premium courses when user is free tier
   - Click on locked course → show upgrade modal
   - Display "FREE" badge on free courses
   - Show progress indicator if user has started course
   ```

4. **Create Upgrade Prompt Modal** (`/src/components/UpgradePromptModal.tsx`)
   ```typescript
   // Triggered when free user tries to access premium content
   // Shows:
   - What they're missing (specific course/feature)
   - Benefits of upgrading
   - Pricing options
   - Direct payment flow integration
   ```

### Phase 4: Payment Integration Updates (Using Stripe MCP)

1. **Create Upgrade Flow**
   - Modify existing payment modal to handle upgrades
   - Create specific upgrade pricing for free users
   - Track conversion metrics

2. **Webhook Updates**
   - Update user's membership_tier to 'paid' upon successful payment
   - Grant access to all courses
   - Send welcome email for new paid members

### Phase 5: UI/UX Updates

1. **Home Page Updates**
   - Change main CTA to "Free Access" 
   - Add value proposition for free tier
   - Show testimonials and upgrade benefits

2. **Dashboard Updates**
   - Show free vs premium content clearly
   - Add upgrade prompts in strategic locations
   - Display progress in free course

## Implementation Steps

### Day 1-2: Database and Backend
- [x] Execute database migrations using Supabase MCP
- [x] Create mock course data
- [x] Update user profile schema
- [x] Create RLS policies for course access

### Day 3-4: Authentication Updates
- [x] Modify signup flow for free tier
  - [x] Update `/src/app/api/auth/signup/route.ts` to handle free tier
  - [x] Create SQL function to auto-grant free course access
  - [ ] Modify email templates for free vs paid users
- [x] Create free access form component
  - [x] Build `/src/components/forms/FreeAccessForm.tsx`
  - [x] Add form validation with zod
  - [x] Integrate with signup API
- [x] Update user onboarding logic
  - [x] Create `/src/app/welcome/free/page.tsx` for free users (removed - direct to classroom)
  - [x] Auto-redirect to classroom after signup
- [x] Test free user registration flow
- [x] Create modal-based authentication flow
  - [x] Create `/src/components/free-signup-modal.tsx`
  - [x] Create `/src/components/login-modal.tsx`
  - [x] Update all CTAs to use modals instead of navigation
- [x] Fix authentication redirect issues
  - [x] Update login flows to use window.location.href
  - [x] Ensure middleware properly validates free tier access

### Day 5-6: Access Control
- [x] Implement access control hooks
  - [x] Update `/src/hooks/use-membership.tsx` for free tier support
  - [x] Add membership tier state tracking
  - [x] Support free tier access validation
- [x] Update navigation controls
  - [x] Update `/src/components/protected-navbar.tsx` for paid-only features
  - [x] Show payment modal for free users on paid features
  - [x] Distinguish between free and paid navigation items
- [x] Create course listing with locks
  - [x] Update `/src/components/CourseCard.tsx` with lock UI
  - [x] Add "FREE" badge component
  - [x] Implement click handlers for locked content
- [x] Build course access validation
  - [x] Create `/src/lib/course-access.ts` service
  - [x] Add server-side route protection
  - [x] Implement client-side redirects
- [x] Add upgrade prompts
  - [x] Create `/src/components/UpgradePromptModal.tsx`
  - [x] Design compelling upgrade messaging
  - [ ] Add analytics tracking

### Day 7-8: Payment Integration
- [x] Update Stripe integration for upgrades
  - [x] Use existing PaymentModal for upgrades
  - [x] Handle free-to-paid conversion in webhook
  - [x] Update user's membership_tier on success
- [x] Simplify upgrade flow
  - [x] Use existing Stripe pricing
  - [x] Leverage existing payment infrastructure
  - [x] No need for special modals or countdown timers
- [ ] Test payment flow
  - [ ] Test with Stripe test cards
  - [ ] Verify tier updates
  - [ ] Check course access changes
- [x] Implement webhook for tier updates
  - [x] Update `/src/app/api/stripe/webhook/route.ts`
  - [x] Update membership_tier on subscription creation
  - [x] Revert to free tier on subscription cancellation
  - [ ] Send upgrade confirmation email

### Day 9-10: UI/UX Polish
- [x] Update home page CTA and copy
  - [x] Change main CTA to "Get Free Access"
  - [x] Remove paid CTA for non-logged users
  - [x] Update CommunityBadge to show only free access
- [x] Update design system consistency
  - [x] Fix all buttons to use gray-900 color
  - [x] Ensure consistent button styling across modals
  - [x] Remove blue color references
- [ ] Design locked course cards
  - [ ] Create hover effects
  - [ ] Add enticing preview content
  - [ ] Show what's inside (tease content)
- [ ] Create upgrade modal variations
  - [ ] A/B test different messages
  - [ ] Test urgency vs value-based messaging
  - [ ] Implement exit-intent popups
- [ ] Track conversion metrics
  - [ ] Set up analytics events
  - [ ] Create conversion funnel dashboard
  - [ ] Monitor drop-off points

## Success Metrics

1. **Conversion Rate**: Free to Paid conversion percentage
2. **Free Course Completion**: Track engagement with free content
3. **Time to Conversion**: Average time from signup to upgrade
4. **Upgrade Trigger Points**: Which locked features drive conversions

## Rollback Plan

If issues arise:
1. Revert membership_tier column to default 'paid'
2. Disable free registration flow
3. Restore original payment-required signup
4. Maintain existing paid user access

## Notes

- Free users can ONLY access designated free course
- No access to threads, calendar, or premium courses
- Clear value proposition for upgrading
- Seamless upgrade experience with saved progress